generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// User model - Represents all users in the system (students, instructors, experts, admins)
/// Handles authentication via NextAuth.js with support for OAuth providers and credentials
model User {
  id               String             @id @default(cuid())
  email            String             @unique
  emailVerified    DateTime?
  password         String?
  name             String
  role             UserRole           @default(STUDENT)
  userLevel        UserLevel          @default(BEGINNER)
  image            String?
  bio              String?
  isActive         Boolean            @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  accounts         Account[]
  achievements     Achievement[]
  learningProgress LearningProgress[] // Legacy
  progress         Progress[]         // New unified progress
  learningSessions LearningSession[]
  quizAttempts     QuizAttempt[]
  searchLogs       SearchLog[]
  sessions         Session[]

  @@index([email])
  @@index([role])
  @@index([userLevel])
  @@index([isActive])
  @@map("users")
}

/// Account model - Stores OAuth provider account information
/// Links user accounts with external OAuth providers (Google, GitHub, etc.)
/// Each user can have multiple accounts (one per provider)
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

/// Session model - Stores active user sessions
/// Used by NextAuth.js database session strategy (alternative to JWT)
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@map("sessions")
}

/// VerificationToken model - Stores tokens for email verification and password reset
/// Used for magic link sign-in and other verification flows
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

/// Module model - Represents a learning module (e.g., "Introduction to Mechanical Ventilation")
/// Modules contain multiple lessons and can have prerequisites
model Module {
  id               String               @id @default(cuid())
  title            String
  description      String?
  order            Int
  category         ModuleCategory
  difficulty       ModuleDifficulty
  estimatedTime    Int
  isActive         Boolean              @default(true)
  thumbnail        String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  isPlaceholder    Boolean              @default(false)
  status           String?              @default("available")
  learningProgress LearningProgress[] // Legacy
  progress         Progress[]         // New unified progress
  lessons          Lesson[]
  prerequisites    ModulePrerequisite[] @relation("ModuleToPrerequisite")
  dependentModules ModulePrerequisite[] @relation("PrerequisiteToModule")

  @@index([category])
  @@index([difficulty])
  @@index([isActive])
  @@index([order])
  @@index([title], map: "modules_title_simple_idx")
  @@index([title(ops: raw("gin_trgm_ops"))], map: "modules_title_gin_idx", type: Gin)
  @@map("modules")
}

/// ModulePrerequisite - Junction table for module prerequisites
/// Defines which modules must be completed before starting another module
model ModulePrerequisite {
  id             String @id @default(cuid())
  moduleId       String
  prerequisiteId String
  module         Module @relation("ModuleToPrerequisite", fields: [moduleId], references: [id], onDelete: Cascade)
  prerequisite   Module @relation("PrerequisiteToModule", fields: [prerequisiteId], references: [id], onDelete: Cascade)

  @@unique([moduleId, prerequisiteId])
  @@index([moduleId])
  @@index([prerequisiteId])
  @@map("module_prerequisites")
}

/// Lesson model - Individual lessons within a module
/// Contains the actual learning content (text, images, videos, etc.)
model Lesson {
  id             String           @id @default(cuid())
  moduleId       String
  title          String
  content        Json              // Changed from String to Json
  order          Int
  difficulty     Difficulty        @default(BEGINNER) // New field
  estimatedTime  Int
  aiGenerated    Boolean          @default(false)
  sourcePrompt   String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  slug           String?
  lessonProgress LessonProgress[] // Legacy
  progress       Progress[]       // New unified progress
  module         Module           @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  quizzes        Quiz[]

  @@index([moduleId])
  @@index([order])
  @@index([slug])
  @@index([title], map: "lessons_title_simple_idx")
  @@index([title(ops: raw("gin_trgm_ops"))], map: "lessons_title_gin_idx", type: Gin)
  @@map("lessons")
}

/// LearningProgress - Tracks user's overall progress in a module (LEGACY)
/// One record per user per module
/// NOTE: Consider migrating to Progress model
model LearningProgress {
  id             String           @id @default(cuid())
  userId         String
  moduleId       String
  completedAt    DateTime?
  timeSpent      Int              @default(0)
  score          Float?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  module         Module           @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonProgress LessonProgress[]

  @@unique([userId, moduleId])
  @@index([userId])
  @@index([moduleId])
  @@map("learning_progress")
}

/// LessonProgress - Tracks user's progress for individual lessons (LEGACY)
/// Provides granular tracking of which lessons have been completed
/// NOTE: Consider migrating to Progress model
model LessonProgress {
  id               String           @id @default(cuid())
  progressId       String
  lessonId         String
  completed        Boolean          @default(false)
  timeSpent        Int              @default(0)
  lastAccessed     DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  progress         Float            @default(0)
  lesson           Lesson           @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  learningProgress LearningProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)

  @@unique([progressId, lessonId])
  @@index([progressId])
  @@index([lessonId])
  @@map("lesson_progress")
}

/// Progress - Unified progress tracking model
/// Can track progress for both modules and lessons
/// One record per user per module OR per user per lesson
model Progress {
  id         String    @id @default(cuid())
  userId     String
  moduleId   String?   // Optional: null if tracking lesson progress
  lessonId   String?   // Optional: null if tracking module progress
  completed  Boolean   @default(false)
  score      Float?
  timeSpent  Int       @default(0)
  lastAccess DateTime  @default(now())
  createdAt  DateTime  @default(now())

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  module Module? @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  lesson Lesson? @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId], name: "progress_user_lesson_unique") // One progress record per user per lesson
  @@unique([userId, moduleId], name: "progress_user_module_unique") // One progress record per user per module
  @@index([userId])
  @@index([moduleId])
  @@index([lessonId])
  @@index([completed])
  @@map("progress")
}

/// Quiz - Questions integrated into lessons for knowledge assessment
/// Can be multiple choice, true/false, or other question types
model Quiz {
  id            String        @id @default(cuid())
  lessonId      String
  question      String
  options       String
  correctAnswer String
  explanation   String?
  order         Int
  points        Int           @default(10)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  quizAttempts  QuizAttempt[]
  lesson        Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
  @@index([order])
  @@map("quizzes")
}

/// QuizAttempt - Records each user's attempt at answering a quiz question
/// Allows tracking of learning patterns and areas needing improvement
model QuizAttempt {
  id          String   @id @default(cuid())
  userId      String
  quizId      String
  answer      String
  isCorrect   Boolean
  timeSpent   Int?
  attemptedAt DateTime @default(now())
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
  @@index([isCorrect])
  @@index([attemptedAt])
  @@map("quiz_attempts")
}

/// LearningSession - Tracks individual study sessions
/// Useful for analytics and understanding user engagement patterns
model LearningSession {
  id              String    @id @default(cuid())
  userId          String
  startTime       DateTime  @default(now())
  endTime         DateTime?
  duration        Int?
  modulesAccessed String?
  lessonsViewed   Int       @default(0)
  quizzesTaken    Int       @default(0)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([startTime])
  @@map("learning_sessions")
}

/// Achievement - Badges and achievements for gamification
/// Motivates users by recognizing milestones and accomplishments
model Achievement {
  id          String          @id @default(cuid())
  userId      String
  type        AchievementType
  title       String
  description String
  icon        String?
  points      Int             @default(0)
  unlockedAt  DateTime        @default(now())
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([unlockedAt])
  @@map("achievements")
}

/// SearchLog model - Tracks user search activity for analytics and improvements
/// Stores search queries, filters, results count, and user interactions
/// Used to identify popular searches, low-quality results, and content gaps
model SearchLog {
  id             String   @id @default(cuid())
  userId         String?
  query          String
  filters        Json?
  resultsCount   Int
  selectedResult String?
  selectedType   String?
  timestamp      DateTime @default(now())
  sessionId      String?
  responseTime   Int?
  user           User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([query])
  @@index([timestamp])
  @@index([sessionId])
  @@index([resultsCount])
  @@map("search_logs")
}

/// AiChatSession - Tracks AI tutor chat sessions
/// Stores session metadata and links to lesson context
model AiChatSession {
  id        String      @id @default(cuid())
  lessonId  String
  sessionId String      @unique
  provider  String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  messages  AiMessage[]

  @@index([lessonId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("ai_chat_sessions")
}

/// AiMessage - Individual messages in AI tutor chat sessions
/// Stores conversation history for context and analytics
model AiMessage {
  id        String        @id @default(cuid())
  sessionId String
  role      String
  content   String
  createdAt DateTime      @default(now())
  session   AiChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@index([role])
  @@map("ai_messages")
}

/// User roles in the VentyLab platform
enum UserRole {
  STUDENT
  TEACHER
  EXPERT
  ADMIN
}

/// User learning level - tracks student's current skill level
enum UserLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum ModuleCategory {
  FUNDAMENTALS
  VENTILATION_PRINCIPLES
  CLINICAL_APPLICATIONS
  ADVANCED_TECHNIQUES
  TROUBLESHOOTING
  PATIENT_SAFETY
}

enum ModuleDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

/// Simplified Role enum for new Progress model
enum Role {
  STUDENT
  TEACHER
  ADMIN
}

/// Simplified Difficulty enum for Lesson model
enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

/// Achievement types for the gamification system
/// Each type represents a specific milestone or accomplishment in the learning journey
enum AchievementType {
  FIRST_LESSON
  FIRST_MODULE
  EXPLORING
  LESSONS_10
  LESSONS_25
  LESSONS_50
  MODULE_COMPLETE
  MODULE_FUNDAMENTALS
  MODULE_VENTILATION
  MODULE_CLINICAL
  MODULE_ADVANCED
  ALL_BEGINNER
  ALL_INTERMEDIATE
  ALL_ADVANCED
  COMPLETE_KNOWLEDGE
  MASTER_LEVEL
  STREAK_3_DAYS
  STREAK_7_DAYS
  STREAK_30_DAYS
  MORNING_LEARNER
  NIGHT_OWL
  DEDICATED_STUDENT
  SPEED_LEARNER
  PERFECT_QUIZ
  FIVE_PERFECT_QUIZZES
  REVIEWING_PRO
  CURIOUS_SEARCHER
  FEEDBACK_CONTRIBUTOR
}
